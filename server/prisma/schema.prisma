generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  // Prisma 7: DO NOT put url/env here anymore.
  // Connection URL is configured in prisma.config.ts instead.
}

model Transaction {
  id        String   @id @default(cuid())
  date      String // YYYY-MM-DD
  amount    Float
  category  String
  merchant  String
  account   String
  note      String   @default("")
  createdAt DateTime @default(now())

  // CSV import helpers
  importHash String?
  // "csv" | "manual" | "recurring"
  source     String?

  // recurring exact linking
  recurringId String?
  recurring   Recurring? @relation(fields: [recurringId], references: [id], onDelete: SetNull)

  // auth scoping
  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  // allow multiple nulls, but prevent duplicates when importHash is set
  @@unique([userId, importHash])
  // Helpful query performance
  @@index([userId, date])
  @@index([userId, category])
  @@index([userId, merchant])
  @@index([userId, recurringId])
}

model Budget {
  id       String @id @default(cuid())
  month    String
  category String
  amount   Float

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  @@unique([userId, month, category])
  @@index([userId, month])
}

model Category {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  @@unique([userId, name])
  @@index([userId])
}

model Rule {
  id        String   @id @default(cuid())
  match     String // substring to look for (store lowercase)
  category  String // category to assign
  createdAt DateTime @default(now())

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([userId, createdAt])
}

model Recurring {
  id         String   @id @default(cuid())
  name       String
  amount     Float
  category   String
  merchant   String
  account    String
  note       String   @default("")
  dayOfMonth Int // 1..28
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  // Back relation (paired with Transaction.recurringId)
  transactions Transaction[]

  @@index([userId])
  @@index([userId, isActive])
}

model User {
  id           String        @id @default(cuid())
  email        String        @unique
  passwordHash String
  createdAt    DateTime      @default(now())
  settings     UserSettings?
  startingBalance Float    @default(0)
  passwordResetTokens PasswordResetToken[]

  transactions Transaction[]
  budgets      Budget[]
  categories   Category[]
  rules        Rule[]
  recurring    Recurring[]

  // ✅ NEW: back-relations for subscriptions
  subscriptions       Subscription[]
  subscriptionIgnores SubscriptionIgnore[]
}

model PasswordResetToken {
  id        String    @id @default(cuid())
  tokenHash String    @unique
  userId    String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model Subscription {
  id             String   @id @default(uuid())
  userId         String
  merchantKey    String // normalized merchant identifier
  displayName    String // user-friendly name
  cadence        String // weekly | monthly | quarterly | yearly | unknown
  expectedAmount Float?
  amountMin      Float?
  amountMax      Float?
  lastDate       String? // YYYY-MM-DD
  nextDate       String? // YYYY-MM-DD
  confidence     Int      @default(0) // 0-100
  isActive       Boolean  @default(true)
  kind           String   @default("subscription") // subscription | bill
  categoryId     String?
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // ✅ NEW: relation to User
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // IMPORTANT: required for upsert by (userId, merchantKey)
  @@unique([userId, merchantKey])
  @@index([userId])
  @@index([userId, isActive])
  @@index([userId, nextDate])
}

model SubscriptionIgnore {
  id          String   @id @default(uuid())
  userId      String
  merchantKey String
  createdAt   DateTime @default(now())

  // ✅ NEW: relation to User
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, merchantKey])
  @@index([userId])
}

model UserSettings {
  id             String   @id @default(cuid())
  userId         String   @unique
  currentBalance Float    @default(0)
  updatedAt      DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}
